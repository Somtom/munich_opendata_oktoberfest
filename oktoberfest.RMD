---
title: "R Notebook"
output: html_notebook
---

# Set up environment

```{r}
require(httr, quietly = T)
require(jsonlite, quietly = T)
require(tidyverse, quietly = T, warn.conflicts = F)
```


# Importing data from API

```{r}
url <- "https://www.opengov-muenchen.de"
path <- "api/action/datastore_search?resource_id=e0f664cf-6dd9-4743-bd2b-81a8b18bd1d2"

# get raw results
raw.result <- GET(url = url, path = path)

# convert raw results to list
result <- content(raw.result)

# convert results to table
dt <- bind_rows(result$result$records)
```


# Prepare data

Let's take a quick view at our data:
```{r}
head(dt)
```


As we see, the columns have german names.
We will change this for all english speaking readers.

```{r}
dt <- dt %>% 
  transmute(id = `_id`,
            year = as.integer(jahr),
            duration = as.integer(dauer),
            beer_cons = as.integer(bier_konsum),
            hendl_cons = as.integer(hendl_konsum),
            beer_price = as.numeric(bier_preis),
            hendl_price = as.numeric(hendl_preis),
            visitors_total = as.numeric(besucher_gesamt),
            visitors_day = as.integer(besucher_tag))
```


# Data description

Our data have `r ncol(dt)` columns and `r nrow(dt)` rows. 
The data set contains yearly data from `r min(dt$year, na.rm = T)` to `r max(dt$year, na.rm = T)` on
beer- and hendl (half chicken) consumption. It also provides information about the price of both as 
well as total visitors, mean daily visitors and the duration.

Variable          | Metric
----------------- | ----------
beer consumption  | Hektoliter
beer price        | €/Liter (before 2002: DM/L)
hendl consumption | ??? 1/2 chicken
hendl price       | € (before 2002: DM)
total visitors    | Million
daily visitors    | Thousand
  

# Data munging


```{r}
# generate vector with years in which zlf festival took place 
zlf_years <- c(seq(1810,1996, 3), seq(2000, max(dt$year),4))

dt <- dt %>% 
  mutate(zlf = factor(ifelse(year %in% zlf_years, 1, 0))) %>% 
  select(-id) # remove is column
```


# Quick plots

## Beer consumption vs. zlf
```{r}
dt %>% 
  ggplot() +
  geom_density(aes(x = beer_cons, fill = zlf), alpha = 0.4) 

dt %>% 
  ggplot() +
  geom_boxplot(aes(x = zlf, y = beer_cons, fill = zlf), alpha = 0.4) 

dt %>% 
  ggplot() +
  geom_col(aes(x =  year, y = beer_cons, fill = zlf)) 
```

## beer and hendl consumption per person

```{r}
dt %>% 
  ggplot() +
  geom_col(aes(x = year, y = beer_cons/visitors_total/10000, fill = beer_price))


dt %>% 
  ggplot() +
  geom_col(aes(x = year, y = hendl_cons/visitors_total/1000000, fill = hendl_price))
```


# Ideas

* Zusätzlicher Datensatz mit Zeltpreisen suchen
